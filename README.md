# kickstartDS Concierge

This repository contains all code related to the kickstartDS Concierge hosted at https://www.kickstartDS.com/concierge

The Concierge can answer user questions by pulling from a big Design System-related knowledge base, gained by scraping manually curated domains on the web.

Crawled HTML gets processed, sections of content are split from it along headline elements, and some metadata is enriched. Finally those sections get transformed to an embedding vector space that is saved to a PostgreSQL database using the `pgvector` extension.

Requests from the page are sent to a Supabase Edge Function, which get's an embedding for the question by calling the Flask webservice contained within this repository. This embedding is then sent to the database to get back the most relevant sections in relation to the question. This then, finally, gets embedded as context into a GPT Completion prompt, which generates the final answer being streamed back to the user. Additionally links and a preview to all referenced pages gets included as context.

## Content

TODO add list of ingested domains.

## Content ingestion

TODO add description

- `notebooks/ingest_content_from_domain.ipynb`
- `notebooks/create_knowledge_base.ipynb`

## Flask webservice

### Run locally

Run app first:

```
FLASK_APP=app flask run
```

Now send questions to the locally running service:

```
curl -d '{"question": "What is a Design System?"}' -H "Content-Type: application/json" -X POST http://127.0.0.1:5000
```

### Run on Fly.io

TODO Document that account is needed, and how it can be obtained.

Install `flyctl` first. E.g. Arch Linux:

```
trizen -S flyctl-bin
```

Log in to your account with `flyctl`:

```
flyctl auth login
```

Deploy a version:

```
flyctl deploy
```

Query the running webservice:

```
curl -d '{"question": "What is a Design System?"}' -H "Content-Type: application/json" -X POST https://question-embedding.fly.dev
```

## Database

This project uses PostgreSQL for data storage, and `pgvector` as an extension specifically:  
https://github.com/pgvector/pgvector

### Installation

Needed tables are generated by `notebooks/create_knowledge_base.ipynb` when `seed = True` is set in cell "Write embeddings to DB".

But you'll need the following `pgsql` database function:

```pgsql
create or replace function match_documents (
  query_embedding vector(768),
  similarity_threshold float,
  match_count int
)
returns table (
  id bigint,
  content text,
  similarity float
)
language plpgsql
as $$
begin
  return query
  select
    id,
    content,
    1 - (documents.embedding <=> query_embedding) as similarity
  from documents
  where 1 - (documents.embedding <=> query_embedding) > similarity_threshold
  order by documents.embedding <=> query_embedding
  limit match_count;
end;
$$;
```

### Supabase

TODO Document that account is needed, possible how login works.

#### Create database function

1. Go to the "SQL editor" section.
2. Click "New Query".
3. Enter the above SQL to create or replace your Database function.
4. Click "Run" or cmd+enter (ctrl+enter).

See also: https://supabase.com/docs/guides/database/functions

#### Create edge function

1. Install Supabase CLI: https://supabase.com/docs/guides/cli
2. Deploy edge function: `supabase functions deploy answer`

Optionally integrate the Deno language server with your editor for autocompletion, etc:  
https://deno.land/manual/getting_started/setup_your_environment

See also: https://supabase.com/docs/guides/functions/quickstart

## Edge Function

TODO Add description

# TODO

- Add LICENSE, etc
- Finish README.md
- Document Codespace use
- Add blurb about being fair / ecosystem-positive, but everybody who wants to be removed from the knowledge base can just contact us to be removed
